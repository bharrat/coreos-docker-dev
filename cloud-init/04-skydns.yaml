#cloud-config

##
## This is a cloud-config for skydns service
##
coreos:
    units:
        - name: skydns-install.service
          command: start
          content: |
              [Unit]
              Description=SkyDNS Installer
              Requires=etcd.service
              After=etcd.service
              Requires=systemd-resolved.service
              After=systemd-resolved.service
              
              [Service]
              Type=oneshot
              RemainAfterExit=true
              EnvironmentFile=/var/lib/skydns/envvars
              ExecStart=-/bin/mkdir -p /opt/bin
              ExecStart=/bin/bash -c "[[ -x /opt/bin/skydns ]] || \
                      curl -L -o /opt/bin/skydns ${SKYDNS_CMD_REPO} && chmod 755 /opt/bin/skydns; echo ok"
              # Set skydns configuration in etcd
              ExecStart=-/var/lib/apps/bin/set-skydns-config ${SKYDNS_CONFIG}
        - name: skydns.service
          command: start
          content: |
              [Unit]
              Description=skydns
              Requires=skydns-install.service
              After=skydns-install.service
              
              [Service]  
              Type=simple
              Restart=always
              RestartSec=5
              EnvironmentFile=/etc/environment
              EnvironmentFile=/var/lib/skydns/envvars
              # make sure the skydns confit is set in etcd:
              ExecStartPre=/bin/bash -c "etcdctl get /skydns/config"
              ExecStart=/opt/bin/skydns
              # with etcd, skydns may not neet to sync with each other anymore:
              ExecStartPost=-/var/lib/apps/bin/dns-set x%m.ns.dns ${COREOS_PRIVATE_IPV4}
              ExecStopPost=-/var/lib/apps/bin/dns-delete x%m.ns.dns
              # set the system resolver to use local skydns
              ExecStartPost=/bin/bash -c "ln -sf /etc/resolv.conf.skydns /etc/resolv.conf"
              ExecStopPost=/bin/bash -c "ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf"
# end of cloud-config skydns
