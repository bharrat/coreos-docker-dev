#cloud-config

coreos:
    fleet:
        etcd_servers: "https://127.0.0.1:4001,https://172.17.8.101:4001,https://172.17.8.102:4001,https://172.17.8.103:4001"
    units:    
        - name: setup-etcdctl-env.service
          command: start
          content: |       
              [Unit]
              Description=Setup etcdctl env vars
              Wants=coreos-setup-environment.service
              After=coreos-setup-environment.service
              
              [Service]
              Type=oneshot
              RemainAfterExit=true
              ExecStart=/bin/bash -c "source /etc/profile.d/etcd-envvars.sh; env | grep -E 'ETCD|FLEETCTL' >> /etc/environment"
              
              [Install]
              WantedBy=multi-user.target

# certs for etcd
write_files:
  - path: /run/systemd/system/etcd.service.d/30-certificates.conf
    permissions: 0644
    content: |
      [Service]
      # Server certs
      Environment=ETCD_CA_FILE=/var/lib/apps/certs/rootCA.pem
      Environment=ETCD_CERT_FILE=/var/lib/apps/certs/etcd.crt
      Environment=ETCD_KEY_FILE=/var/lib/apps/certs/etcd.key
      # Peer certs
      Environment=ETCD_PEER_CA_FILE=/var/lib/apps/certs/rootCA.pem
      Environment=ETCD_PEER_CERT_FILE=/var/lib/apps/certs/etcd.crt
      Environment=ETCD_PEER_KEY_FILE=/var/lib/apps/certs/etcd.key
      
  - path: /etc/profile.d/etcd-envvars.sh
    permissions: 0644
    owner: root
    content: |
      ##########################################################
      # Use secure etcd service
      # these env vars are necessary for tools that talk to etcd
      # 
      # make sure this file has the right values and drop it
      # under the /etc/profile.d
      
      # for etcdctl
      export ETCDCTL_PEERS="https://127.0.0.1:4001,https://172.17.8.101:4001,https://172.17.8.102:4001,https://172.17.8.103:4001"
      
      # for fleetctl. Note: FLEETCTL_ENDPOINT only take one url
      export FLEETCTL_ENDPOINT="https://172.17.8.101:4001"
      export ETCD_CAFILE=/var/lib/apps/certs/rootCA.pem
      export ETCD_CERTFILE=/var/lib/apps/certs/etcd-client.crt
      export ETCD_KEYFILE=/var/lib/apps/certs/etcd-client.key
      
      # for skydns
      export ETCD_MACHINES=$ETCDCTL_PEERS
      export ETCD_CACERT=/var/lib/apps/certs/rootCA.pem
      export ETCD_TLSPEM=/var/lib/apps/certs/etcd-client.crt
      export ETCD_TLSKEY=/var/lib/apps/certs/etcd-client.key

